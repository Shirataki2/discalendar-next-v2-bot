# DisCalendar Bot 手動テストケース

Discord経由での動作確認を行うための網羅的なテストケースです。

## 目次

1. [前提条件](#前提条件)
2. [/create コマンド](#create-コマンド)
3. [/list コマンド](#list-コマンド)
4. [/init コマンド](#init-コマンド)
5. [/help コマンド](#help-コマンド)
6. [/invite コマンド](#invite-コマンド)
7. [Guild イベント](#guild-イベント)
8. [通知タスク](#通知タスク)
9. [プレゼンスタスク](#プレゼンスタスク)

---

## 前提条件

- [ ] Botがテストサーバーに招待されている
- [ ] Botに必要な権限（Send Messages, Embed Links）が付与されている
- [ ] 環境変数（BOT_TOKEN, SUPABASE_URL, SUPABASE_SERVICE_KEY等）が設定されている
- [ ] Botがオンラインで動作している

---

## /create コマンド

予定を新規作成するコマンド。

### 正常系

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| C-01 | 必須項目のみで予定作成 | 1. `/create`を入力<br>2. name: "テスト予定"<br>3. 開始: 2026/01/05 10:00<br>4. 終了: 2026/01/05 11:00<br>5. 他はデフォルト | "正常に予定を作成しました"のメッセージと予定のEmbedが表示される |
| C-02 | 全項目を指定して予定作成 | 1. `/create`を入力<br>2. name: "会議"<br>3. description: "月例会議"<br>4. 開始: 2026/01/10 14:00<br>5. 終了: 2026/01/10 15:30<br>6. is_all_day: False<br>7. color: 赤<br>8. notify_1: 30分前<br>9. notify_2: 1時間前 | Embedに全情報が反映された予定が作成される（色が赤、通知設定が表示） |
| C-03 | 終日イベント作成 | 1. `/create`を入力<br>2. name: "祝日"<br>3. 開始: 2026/01/15 00:00<br>4. 終了: 2026/01/15 23:59<br>5. is_all_day: True | 終日フラグがオンの予定が作成される |
| C-04 | 複数日にまたがる予定作成 | 1. `/create`を入力<br>2. name: "合宿"<br>3. 開始: 2026/02/01 09:00<br>4. 終了: 2026/02/03 18:00 | 複数日にまたがる予定が正常に作成される |
| C-05 | 各色での予定作成 | 各色（白/黒/赤/青/緑/黄/紫/灰/茶/水色）で予定を作成 | それぞれの色でEmbedが表示される |
| C-06 | 通知4つ全て設定 | notify_1〜notify_4を全て異なる値で設定 | 4つの通知設定が保存される |
| C-07 | 日本語名での予定作成 | name: "日本語テスト予定🎉" | 日本語・絵文字を含む名前で予定が作成される |

### 異常系

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| C-E01 | DMでの実行 | BotにDMで`/create`を実行 | "このコマンドはサーバーでのみ実行可能です"（ephemeral） |
| C-E02 | 無効な開始日時 | start_month: 13, start_day: 32 | "無効な開始日時です"エラーメッセージ（ephemeral） |
| C-E03 | 無効な終了日時 | end_month: 2, end_day: 30（閏年でない場合） | "無効な終了日時です"エラーメッセージ（ephemeral） |
| C-E04 | 開始 > 終了 | 開始: 2026/01/10 15:00<br>終了: 2026/01/10 14:00 | "開始時間が終了時間より後になっています"（ephemeral） |
| C-E05 | 制限モードで権限なしユーザーが作成 | 1. guild_configでrestricted=trueを設定<br>2. 権限のない一般ユーザーで`/create`実行 | "管理者」「サーバー管理」「ロールの管理」「メッセージの管理」のいずれかの権限が必要です"（ephemeral） |
| C-E06 | 2月29日（平年）を指定 | start_year: 2027, start_month: 2, start_day: 29 | "無効な開始日時です"エラーメッセージ |

### エッジケース

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| C-EC01 | 最大文字数の予定名 | name: 255文字の文字列 | 正常に予定が作成される |
| C-EC02 | 同一時刻の予定 | 開始 = 終了（2026/01/05 10:00） | 正常に予定が作成される（0分の予定） |
| C-EC03 | 2月29日（閏年）を指定 | start_year: 2028, start_month: 2, start_day: 29 | 正常に予定が作成される |
| C-EC04 | 年末年始をまたぐ予定 | 開始: 2026/12/31 22:00<br>終了: 2027/01/01 02:00 | 正常に予定が作成される |
| C-EC05 | 過去日時の予定作成 | 開始・終了を過去の日時に設定 | 正常に予定が作成される（バリデーションなし） |
| C-EC06 | 制限モードで管理者が作成 | 1. guild_configでrestricted=trueを設定<br>2. 管理者権限持ちユーザーで`/create`実行 | 正常に予定が作成される |
| C-EC07 | 同じ通知タイミングを複数指定 | notify_1: 30分前, notify_2: 30分前 | 重複した通知が保存される（仕様確認必要） |

---

## /list コマンド

予定一覧を表示するコマンド。

### 正常系

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| L-01 | 未来の予定一覧（デフォルト） | 1. 未来の予定を3件作成<br>2. `/list`を実行 | 未来の予定3件がEmbedで表示される |
| L-02 | 過去の予定一覧 | 1. 過去の予定をDBに直接作成<br>2. `/list range:過去`を実行 | 過去の予定がEmbedで表示される |
| L-03 | 全ての予定一覧 | 1. 過去・未来の予定を作成<br>2. `/list range:全て`を実行 | 全ての予定がEmbedで表示される |
| L-04 | ページネーション（次へ） | 1. 5件以上の予定を作成<br>2. `/list`を実行<br>3. ▶ボタンをクリック | 2ページ目の予定が表示される |
| L-05 | ページネーション（前へ） | 1. 5件以上の予定を作成<br>2. `/list`を実行<br>3. ▶をクリック後◀をクリック | 1ページ目に戻る |
| L-06 | 通知設定付き予定の表示 | 通知設定のある予定を表示 | 通知欄に"5分前, 1時間前"等が表示される |

### 異常系

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| L-E01 | DMでの実行 | BotにDMで`/list`を実行 | "このコマンドはサーバーでのみ実行可能です"（ephemeral） |
| L-E02 | 予定が0件の場合 | 予定が1件もないサーバーで`/list`実行 | "現在登録されている予定はありません"（ephemeral） |

### エッジケース

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| L-EC01 | 4件ちょうど（1ページ分） | 4件の予定で`/list`実行 | 1ページに4件表示、ページネーションボタンは無効化 |
| L-EC02 | 5件（2ページ目が1件） | 5件の予定で`/list`実行 | 1ページ目に4件、2ページ目に1件 |
| L-EC03 | Viewタイムアウト | `/list`実行後180秒以上放置 | ボタンが無効化される（タイムアウト） |
| L-EC04 | 他ユーザーがボタン操作 | ユーザーAが`/list`実行後、ユーザーBがボタンをクリック | ボタン操作可能（Interactionは編集可能な仕様） |
| L-EC05 | 通知なしの予定表示 | 通知設定のない予定を表示 | 通知欄に"なし"と表示される |

---

## /init コマンド

通知先チャンネルを設定するコマンド。

### 正常系

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| I-01 | 初回設定（現在チャンネル） | 管理者権限で`/init`実行（channel未指定） | "イベント通知を有効にしました\n通知先: #(実行チャンネル)" |
| I-02 | 初回設定（指定チャンネル） | 管理者権限で`/init channel:#通知用`実行 | "イベント通知を有効にしました\n通知先: #通知用" |
| I-03 | 設定変更 | 1. 初回設定済み<br>2. 管理者権限で`/init channel:#新チャンネル`実行 | "イベント通知先を変更しました\n通知先: #旧チャンネル → #新チャンネル" |
| I-04 | サーバー管理権限で実行 | manage_guild権限持ちで`/init`実行 | 正常に設定できる |
| I-05 | ロール管理権限で実行 | manage_roles権限持ちで`/init`実行 | 正常に設定できる |
| I-06 | メッセージ管理権限で実行 | manage_messages権限持ちで`/init`実行 | 正常に設定できる |

### 異常系

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| I-E01 | DMでの実行 | BotにDMで`/init`を実行 | "このコマンドはサーバー内で実行してください"（ephemeral） |
| I-E02 | 権限なしユーザーが実行 | 管理系権限のないユーザーで`/init`実行 | "「管理者」「サーバー管理」「ロールの管理」「メッセージの管理」のいずれかの権限が必要です"（ephemeral） |

### エッジケース

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| I-EC01 | 同じチャンネルに再設定 | 既存の通知チャンネルと同じチャンネルを指定 | "イベント通知先を変更しました"（同じチャンネルへの変更） |
| I-EC02 | Botがアクセスできないチャンネル | Botに閲覧権限のないチャンネルを指定 | 設定は成功するが、通知送信時にエラーになる |
| I-EC03 | ボイスチャンネルを指定 | `/init channel:#ボイスチャンネル` | Discordの入力補完でテキストチャンネルのみ表示される（型制約） |

---

## /help コマンド

ヘルプ情報を表示するコマンド。

### 正常系

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| H-01 | ヘルプ表示 | `/help`を実行 | ヘルプ情報のEmbedが表示される（ephemeral） |
| H-02 | サーバー内で実行 | サーバーのテキストチャンネルで`/help`実行 | 正常にヘルプが表示される |
| H-03 | DMで実行 | BotにDMで`/help`実行 | 正常にヘルプが表示される |

### エッジケース

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| H-EC01 | Botアバターなし | Botにアバターが設定されていない状態で`/help`実行 | アバターなしでもエラーにならない |
| H-EC02 | 招待URL未設定 | INVITATION_URL環境変数未設定で`/help`実行 | 招待URLなしでもエラーにならない（空文字またはデフォルト値） |

---

## /invite コマンド

Bot招待URLを表示するコマンド。

### 正常系

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| IV-01 | 招待URL表示 | `/invite`を実行 | 招待URLがメッセージとして表示される |
| IV-02 | サーバー内で実行 | サーバーのテキストチャンネルで`/invite`実行 | 正常にURLが表示される |
| IV-03 | DMで実行 | BotにDMで`/invite`実行 | 正常にURLが表示される |

### エッジケース

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| IV-EC01 | 招待URL未設定 | INVITATION_URL環境変数未設定で実行 | 空文字またはデフォルト値が表示される |

---

## Guild イベント

Botのサーバー参加/退出/更新時のイベントハンドラ。

### 正常系

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| G-01 | サーバー参加（新規） | 新しいサーバーにBotを招待 | guildsテーブルにサーバー情報が追加される |
| G-02 | サーバー退出 | BotをサーバーからKick | guildsテーブルからサーバー情報が削除される |
| G-03 | サーバー名変更 | サーバー名を変更 | guildsテーブルの名前が更新される |
| G-04 | サーバーアイコン変更 | サーバーアイコンを変更 | guildsテーブルのavatar_urlが更新される |

### 異常系

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| G-E01 | DB接続エラー時の参加 | DB接続不可の状態でサーバーに参加 | エラーログが記録される（Botは動作継続） |

### エッジケース

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| G-EC01 | 既存サーバーに再参加 | 一度退出したサーバーに再度Botを招待 | guildsテーブルに情報が再作成される |
| G-EC02 | サーバー情報変更なし | サーバー設定で名前・アイコン以外を変更 | データベースは更新されない |
| G-EC03 | アイコンなしサーバー | アイコンが設定されていないサーバーに参加 | avatar_url: nullで保存される |

---

## 通知タスク

60秒ごとに実行される予定通知タスク。

### 正常系

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| N-01 | 通知時刻に通知送信 | 1. `/init`で通知チャンネル設定<br>2. 現在時刻から5分後に開始する予定を作成（5分前通知設定）<br>3. 5分待機 | 通知チャンネルに"5分後に以下の予定が開催されます"のEmbedが送信される |
| N-02 | イベント開始時の通知 | 1. 通知設定なしで現在時刻に開始する予定を作成<br>2. 1分以内に確認 | "以下の予定が開催されます"のEmbedが送信される |
| N-03 | 複数通知設定 | 1時間前、30分前、5分前に通知設定した予定 | 各タイミングで3回通知が送信される |
| N-04 | 終日イベントの通知 | is_all_day=trueの予定で通知設定 | 0:00に通知が送信される |

### 異常系

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| N-E01 | 通知チャンネル未設定 | event_settingsがない状態で予定作成 | 通知は送信されない（エラーにはならない） |
| N-E02 | 削除されたチャンネル | 設定後にチャンネルを削除 | 通知スキップ（channel is None） |
| N-E03 | 権限不足（送信不可） | Botに送信権限がないチャンネルを設定 | Forbiddenエラーがログに記録、通知失敗 |
| N-E04 | Embed送信失敗 | Embed送信でHTTPExceptionが発生 | プレーンテキストにフォールバック |

### エッジケース

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| N-EC01 | 複数サーバーで同時刻の予定 | 複数サーバーで同じ時刻の予定を作成 | 各サーバーの通知チャンネルにそれぞれ通知が送信される |
| N-EC02 | 同一予定で複数回通知 | 5分前と開始時刻の通知を両方設定 | 5分前と開始時刻の両方で通知が送信される |
| N-EC03 | 過去の予定（通知漏れ） | 通知タイミングを過ぎた予定 | 通知は送信されない（過去の通知はスキップ） |
| N-EC04 | 日前通知 | 7日前通知を設定した予定 | 7日前の該当時刻に通知が送信される |

---

## プレゼンスタスク

10秒ごとにBotのステータスを更新するタスク。

### 正常系

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| P-01 | ステータス"cal help" | Bot起動後10秒以内に確認 | "cal help を視聴中"が表示される |
| P-02 | ステータス"/help" | 起動後20秒で確認 | "/help を視聴中"が表示される |
| P-03 | ステータス"N servers" | 起動後30秒で確認 | "(サーバー数) servers を視聴中"が表示される |
| P-04 | ステータス"discalendar.app" | 起動後40秒で確認 | "discalendar.app を再生中"が表示される |
| P-05 | ステータスサイクル | 50秒待機して確認 | 再び"cal help を視聴中"に戻る |

### エッジケース

| No. | テストケース | 手順 | 期待値 |
|-----|-------------|------|--------|
| P-EC01 | サーバー0件 | Botがどのサーバーにも参加していない状態 | "0 servers を視聴中"が表示される |
| P-EC02 | 多数サーバー | 100以上のサーバーに参加 | "100 servers を視聴中"が正しく表示される |

---

## 権限チェック一覧

以下の権限がある場合、管理系コマンドを実行可能：

| 権限 | `/init` | `/create`（制限モード時） |
|------|---------|--------------------------|
| Administrator | ✅ | ✅ |
| Manage Guild | ✅ | ✅ |
| Manage Roles | ✅ | ✅ |
| Manage Messages | ✅ | ✅ |
| 上記以外のみ | ❌ | ❌ |

---

## テスト実行チェックリスト

### 環境準備
- [ ] テスト用Discordサーバーを作成
- [ ] Botをテストサーバーに招待
- [ ] テスト用の各種権限を持つロールを作成
- [ ] テスト用ユーザーアカウントを準備（管理者/一般ユーザー）

### テスト後のクリーンアップ
- [ ] 作成したテスト予定を削除
- [ ] event_settings をリセット
- [ ] guild_config をリセット

---

## 付録: テストデータ例

### 予定作成テストデータ

```
名前: テスト予定
説明: これはテスト用の予定です
開始: 2026/01/10 14:00
終了: 2026/01/10 15:00
終日: false
色: 青
通知1: 30分前
通知2: 1時間前
```

### 通知テスト用タイミング計算

現在時刻が `2026/01/03 15:00` の場合：

| 通知タイミング | 予定開始時刻の設定 |
|----------------|-------------------|
| 即時通知テスト | 15:01〜15:02（次の分） |
| 5分前通知テスト | 15:06〜15:07 |
| 30分前通知テスト | 15:31〜15:32 |
| 1時間前通知テスト | 16:01〜16:02 |
